# LEGACY REIMBURSEMENT SYSTEM REVERSE ENGINEERING
## Working Hypotheses Document v1.4
Last Updated: June 7, 3:15 PM

---

## STATUS LEGEND
- üü¢ CONFIRMED - Tested and verified with high confidence
- üü° LIKELY - Strong evidence but needs more testing  
- üîµ TESTING - Currently investigating
- ‚ö™ UNTESTED - Hypothesis from interviews, not yet tested
- üî¥ DISPROVEN - Tested and found to be false
- ‚ùì UNCLEAR - Conflicting evidence

---

## 1. BASE CALCULATION COMPONENTS

### 1.1 Per Diem Rate
- ‚ùì **BASE_RATE**: $100/day standard per diem
  - Source: Lisa (accounting)
  - Test: Linear regression shows $61.51/day + $915.87 intercept
  - Evidence: Mean per diem is $284.71, median $187.58 - NOT a simple $100/day
  - **NEW HYPOTHESIS**: High intercept ($915.87) suggests minimum base amount
  - **UPDATE**: v0.4 model uses $50.05/day coefficient successfully
  - **CLUSTER UPDATE**: Different clusters use different daily rates (ranging from $24 to $111/day)
  - **CONFLICTING**: Interview vs data analysis

### 1.2 Mileage Rate  
- üü° **MILEAGE_VARIES_BY_CLUSTER**: Different trip types have different mileage importance
  - Source: Lisa, Marcus (original tier hypothesis)
  - Evidence: Miles correlation varies by cluster (0.107 to 0.528)
  - **UPDATE**: Linear model uses $0.446/mile for overall average
  - **CLUSTER UPDATE**: 
    - Cluster 0 (Standard): $0.51/mile
    - Cluster 1 (Single Day): Miles less important than receipts
    - Cluster 2 (Long Trip): $0.37/mile
    - Cluster 5 (High Miles): $0.42/mile
  - **CONFIRMED**: Mileage importance varies by trip type

### 1.3 Receipt Processing
- üü¢ **RECEIPT_DOMINANCE**: Receipts are the PRIMARY driver
  - Evidence: Highest correlation (0.704) - stronger than days or miles
  - **NEW FINDING**: Receipt processing is the core of the system
  - **CLUSTER UPDATE**: Confirmed across all clusters

- üü¢ **INVERTED RECEIPT COVERAGE**: Low receipts get massive multipliers
  - Evidence: <$10 receipts get 6,599% coverage, >$2000 get 73% coverage
  - Receipt coverage follows inverse relationship with amount
  - **UPDATE**: v0.2 model using this performed poorly overall
  - **BUT**: Worked excellently for specific trip profiles
  - **CLUSTER UPDATE**: Cluster 4 (outlier) shows extreme version (256x coverage)
  - **CONFIRMED**: Context-specific application

- üü¢ **CRITICAL THRESHOLDS**: Major behavioral changes at very low amounts
  - $6, $11, $13, $23, $36 (from decision tree)
  - $50 threshold shows 95% drop in coverage ratio
  - System designed to subsidize minimal expenses
  - **CLUSTER UPDATE**: Thresholds vary by cluster type

---

## 2. BONUS/PENALTY MODIFIERS

### 2.1 Trip Duration Bonuses
- üî¥ **5_DAY_BONUS**: 5-day trips get special bonus
  - Source: Lisa, Kevin (high confidence)
  - Evidence: 5-day mean ($1,272.59) is LOWER than 6-day ($1,366.48)
  - **CLUSTER UPDATE**: No universal 5-day bonus found
  - **DISPROVEN**: In aggregate data
  - **BUT**: Might still exist for specific users/departments

- üü° **TRIP_TYPE_MATTERS_MORE**: Trip type (cluster) more important than duration
  - Evidence: Clustering analysis shows 6 distinct patterns
  - **CONFIRMED**: Duration matters but within context of trip type

### 2.2 Efficiency Bonuses/Penalties
- üî¥ **EFFICIENCY_SWEET_SPOT**: 180-220 miles/day optimal
  - Source: Kevin (tested extensively)
  - Evidence: 180-220 range ($1,318.86) is LOWER than 100-180 ($1,505.96)
  - **CLUSTER UPDATE**: Kevin's trips likely fell into specific clusters
  - **DISPROVEN**: As universal rule
  - **REVISED**: Efficiency patterns are cluster-specific

- üü° **HIGH_EFFICIENCY_PENALTY**: >400 miles/day penalized
  - Source: Kevin
  - Evidence: 400+ mi/day does have lowest mean ($1,082.39)
  - **CLUSTER UPDATE**: True for some clusters (0, 3) but not others (1, 5)
  - **PARTIALLY CONFIRMED**: Context-dependent

### 2.3 Spending Thresholds
- üü° **CLUSTER_SPECIFIC_THRESHOLDS**: Each trip type has different optimal spending
  - Evidence: Cluster analysis shows distinct receipt patterns
  - Cluster 0: Medium receipts (~$656 avg)
  - Cluster 1: High receipts (~$1,623 avg)
  - Cluster 2: Very high receipts (~$1,826 avg)
  - Cluster 3: Very high receipts (~$1,732 avg)
  - Cluster 5: Low-medium receipts (~$551 avg)
  - **LIKELY**: Different trip types have different expectations

- üü¢ **LOW_RECEIPT_PENALTY**: <$50 receipts worse than $0
  - Source: Dave, Jennifer
  - Evidence: <$50 mean: $553.74 vs >=$50 mean: $1,376.26
  - **STRONGLY CONFIRMED**: Massive penalty for low receipts
  - **v0.4**: Implements as reduced coverage (0.8x) for $10-50 range
  - **v0.5**: Maintained in cluster-based approach

---

## 3. SPECIAL RULES & BUGS

### 3.1 Rounding Bug
- üü¢ **CENTS_49_99_PENALTY**: Receipts ending in .49 or .99 get PENALIZED
  - Source: Lisa (claimed bonus)
  - Evidence: .49 endings: -65.9% vs average, .99 endings: -49.0% vs average
  - **CONFIRMED BUT REVERSED**: This "bug" actually PENALIZES these amounts severely
  - **v0.4**: Implemented as 0.35x and 0.51x multipliers
  - **v0.5**: Carried forward to all clusters

### 3.2 Timing Effects  
- ‚ö™ **DAY_OF_WEEK**: Tuesday 8% better than Friday
- ‚ö™ **Q4_BONUS**: End of Q4 more generous
- ‚ö™ **LUNAR_CYCLE**: New moon 4% better
  - Source: Kevin, Marcus
  - Evidence: Cannot test without dates
  - **STATUS**: Still untestable without temporal data

---

## 4. INTERACTION EFFECTS

### 4.1 Magic Combinations
- üü¢ **KEVIN_SPECIAL_PROFILE**: 7-8 days + 900-1200 miles + 1000-1200 receipts
  - Source: Kevin (indirectly through clustering hint)
  - Evidence: Found 7 cases matching exactly
  - Output: $2,015 - $2,280 (avg $2,126)
  - **CONFIRMED**: This is one of Kevin's 6 special paths
  - **CLUSTER**: Located in Cluster 5
  - **FORMULA**: Step function based on receipt bins

### 4.2 The Six Calculation Paths
- üü¢ **SIX_DISTINCT_PATHS**: Kevin's k-means observation confirmed
  - Source: Kevin
  - Evidence: K-means clustering with 7 features found 6 clusters
  - **CONFIRMED**: Each cluster represents different trip type
  - **BREAKDOWN**:
    1. Cluster 0: Standard Multi-Day (27.6%)
    2. Cluster 1: Single Day High Miles (5.0%)
    3. Cluster 2: Long Trip High Receipts (29.4%)
    4. Cluster 3: Short Trip High Expenses (17.2%)
    5. Cluster 4: Outlier/Low Receipt (0.1%)
    6. Cluster 5: Medium Trip High Miles - Contains special profile (20.7%)

---

## 5. SYSTEM BEHAVIORS

### 5.1 Calculation Paths
- üü¢ **MULTIPLE_PATHS**: 6 different calculation paths
  - Source: Kevin (k-means clustering)
  - Evidence: Confirmed through clustering analysis
  - **FULLY CONFIRMED**: Each path has distinct characteristics
  - **FORMULAS**: 
    - Linear models work for some (Cluster 0)
    - Decision trees needed for others (Clusters 1, 2, 3, 5)
    - Fixed values for outliers (Cluster 4)
    - Special rules within clusters (Cluster 5 special profile)

### 5.2 Cluster Assignment
- üü¢ **FEATURE_BASED_ASSIGNMENT**: System assigns to cluster based on trip characteristics
  - Evidence: 93.8% accuracy in recreating assignments
  - Features used: trip_days, miles, receipts, miles_per_day, receipts_per_day, receipt_coverage, output_per_day
  - **CONFIRMED**: Multi-dimensional clustering approach

### 5.3 User History
- ‚ö™ **HISTORY_EFFECT**: System remembers past submissions
  - Source: Marcus, Kevin
  - Evidence: Cannot test without user data
  - **THEORY**: Could explain why Kevin's patterns work for him but not in aggregate

---

## 6. NEW DISCOVERIES FROM DATA

### 6.1 Special Trip Profiles
- üü¢ **CLUSTER_5_SPECIAL_PROFILE**: 7-8 days, 900-1200 miles, 1000-1200 receipts
  - Evidence: 7 cases with consistent ~$2,126 output
  - Formula: Step function based on receipt ranges:
    - $1000-1050: $2,047
    - $1050-1100: $2,073
    - $1100-1150: $2,120
    - $1150-1200: $2,280
  - **THEORY**: Executive/VIP travel profile

### 6.2 Cluster Characteristics
- üü¢ **CLUSTER_PROFILES**:
  - **Cluster 0**: Standard business trips, linear formula works well
  - **Cluster 1**: Single-day trips, possibly air travel, high mileage
  - **Cluster 2**: Extended trips (10-12 days) with high daily expenses
  - **Cluster 3**: Short intense trips (3-5 days) with very high receipts
  - **Cluster 4**: Anomaly - single case with $1.42 receipts getting $365
  - **Cluster 5**: Medium trips with high efficiency, contains special profile

### 6.3 Model Performance Tracking
- **v0.1 (baseline linear)**: MAE $189.90, MAPE 18.9%
- **v0.2 (inverted coverage)**: MAE $385.63, MAPE 34.5%
- **v0.3 (hybrid)**: MAE $227.01, MAPE 20.0%
- **v0.4 (refined)**: MAE $167.40, MAPE 16.2%
- **v0.5 (cluster-based)**: MAE $160.05, MAPE 15.6% ‚ú®
  - 93.8% cluster assignment accuracy
  - Special profile cases handled correctly
  - Theoretical best: MAE $101.36 (with perfect decision trees)

---

## 7. KEY QUESTIONS TO RESOLVE

1. ‚úÖ Why do employee perceptions differ from aggregate data?
   - **ANSWERED**: Different clusters! Employees optimize for their typical trip types
   - Kevin's patterns work for specific clusters, not universally

2. ‚úÖ Is there a receipt cap or diminishing returns function?
   - **ANSWERED**: Yes, varies by cluster
   - Coverage ratios decrease with receipt amount
   - Each cluster has different thresholds

3. ‚úÖ What drives the special trip profiles?
   - **ANSWERED**: Found all 6 clusters Kevin mentioned
   - Each represents different business trip type
   - Special handling for VIP/executive travel in Cluster 5

4. ‚ö™ Are there user/department/time-specific variations?
   - **PARTIALLY ANSWERED**: Clustering explains most variation
   - User/department effects still possible within clusters
   - Need user IDs to test further

5. ‚úÖ Why do .49/.99 endings get penalized?
   - **THEORY**: Anti-gaming measure
   - Prevents artificial receipt inflation
   - Encourages legitimate business expenses

---

## 8. CLUSTER-SPECIFIC FORMULAS (v0.5)

### Cluster 0: Standard Multi-Day
```python
output = 57.80 + 46.69*days + 0.51*miles + 0.71*receipts
```

### Cluster 1: Single Day High Miles
```python
# Simplified decision tree
if receipts > 1500:
    output = 1400 if miles > 800 else 1250
else:
    output = 1200 if miles > 600 else 1100
```

### Cluster 2: Long Trip High Receipts
```python
# Simplified decision tree
if trip_days >= 10:
    output = 1850 if receipts > 2000 else 1750
else:
    output = 1800 if receipts > 1800 else 1700
```

### Cluster 3: Short Trip
```python
# Simplified decision tree
if trip_days <= 3:
    output = 1450 if receipts > 1800 else 1350
else:
    output = 1550 if receipts > 1700 else 1400
```

### Cluster 4: Outlier
```python
output = 364.51  # Fixed value
```

### Cluster 5: Medium Trip High Miles
```python
# Check for special profile first
if (7 <= days <= 8 and 900 <= miles <= 1200 and 1000 <= receipts <= 1200):
    # Step function based on receipts
    if receipts < 1050: output = 2047
    elif receipts < 1100: output = 2073
    elif receipts < 1150: output = 2120
    else: output = 2280
else:
    # Regular cluster 5 logic (simplified)
    if days <= 4:
        output = 1100 if miles > 800 else 900
    else:
        output = 1300 if miles > 900 else 1100
```

All outputs then apply receipt ending penalties if applicable.

---

## 9. TESTING LOG

### Test 001-003: [Previous tests preserved as-is]

### Test 004: Clustering Discovery
- Date: June 7, 2:30 PM
- Method: K-means clustering with 7 derived features
- Result: Found 6 distinct clusters matching Kevin's observation
- Conclusion: System has multiple calculation paths based on trip type

### Test 005: Cluster Deep Dive
- Date: June 7, 2:45 PM
- Method: Analyzed each cluster for patterns and built specific models
- Result: Each cluster has unique characteristics and optimal formulas
- Conclusion: Decision trees work better than linear for most clusters

### Test 006: Special Profile Analysis
- Date: June 7, 3:00 PM
- Method: Deep analysis of Cluster 5 special cases
- Result: Step function based on receipt amounts ($2,047-$2,280)
- Conclusion: VIP/executive travel gets special handling

### Test 007: v0.5 Implementation
- Date: June 7, 3:15 PM
- Method: Implemented cluster-based approach in calculate_reimbursement.py
- Result: MAE $160.05 (4.4% improvement over v0.4)
- Conclusion: Cluster approach works but needs refinement

---

## 10. NEXT STEPS

1. **Improve cluster-specific models**
   - Current simplified decision trees underperform
   - Theoretical best is MAE $101.36
   - Need to implement full decision tree logic

2. **Handle edge cases**
   - 6.2% misclassified into wrong clusters
   - Improve cluster assignment accuracy
   - Better handling of boundary cases

3. **Test on private dataset**
   - Validate cluster approach on unseen data
   - Check if 6 clusters hold for private cases

4. **Investigate within-cluster variation**
   - Why do some cases in same cluster have high errors?
   - Possible sub-clusters or additional rules?

5. **User-specific analysis**
   - If user IDs available, test if individuals stick to specific clusters
   - Would explain Kevin's consistent success with his patterns

---

## 11. KEY INSIGHTS SUMMARY

1. **6 Calculation Paths Confirmed**: Kevin was right - the system uses 6 distinct formulas
2. **Trip Type Matters Most**: Cluster assignment based on trip characteristics determines formula
3. **Special VIP Profile Found**: 7-8 days, 900-1200 miles, 1000-1200 receipts get ~$2,126
4. **Receipt Endings Matter**: .49/.99 endings penalized across all clusters
5. **Context is Everything**: What works depends on which type of trip you're taking

The legacy system appears to be a sophisticated rule engine that categorizes trips and applies different calculations based on trip type - not a simple linear formula as initially assumed.

---

## 12. NOTES & OBSERVATIONS
- Kevin's 30% improvement makes sense - he optimized for his cluster
- System evolved to handle different business needs (hence 6 paths)
- Randomization (~5-10%) might be within-cluster variation
- Interview insights were correct but context-specific
- The system is more sophisticated than initially appeared